function reverse_avatars(){Game.paused=!0,setTimeout(function(){var a=player.avatar;player.avatar=opponent.avatar,opponent.avatar=a},500),setTimeout(function(){Game.paused=!1},1e3)}function add_to_reverse_meter(){Game.paused||(reverse_meter++,player.score-player.old_score<opponent.score-opponent.old_score&&reverse_meter++,player.old_score=player.score,opponent.old_score=opponent.score,reverse_meter>REVERSE_MAX&&(reverse_meter=REVERSE_MAX))}var utils,sc,nm,ga,graphics,input,player,opponent,game_name,game_minutes,game_seconds,game_centa_seconds,is_host,reverse_meter=0,rolling_niblit_id=1,niblits_eaten=[],host_interval,spawn_interval,reverse_meter_interval,SCREEN_WIDTH=720,SCREEN_HEIGHT=640;ARENA_WIDTH=1200,ARENA_HEIGHT=1200,MAX_NIBLITS=200,REVERSE_MAX=100,DOMURL=window.URL||window.webkitURL||window,ART_COMMON='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.0" x="0px" y="0px" viewBox="0 0 150 150" enable-background="new 0 0 150 150" xml:space="preserve">',ART={nomHead:ART_COMMON+'<g><circle fill="#32D95C" cx="74" cy="75" r="71"/></g><circle fill="#ECF230" cx="74" cy="50" r="22"/><circle cx="74" cy="49" r="10"/></svg>',monHead:ART_COMMON+'<g><circle fill="#FF5A35" cx="72" cy="75" r="67"/></g><circle fill="#ECF230" cx="38" cy="50" r="12"/><circle fill="#ECF230" cx="73" cy="47" r="13"/><circle fill="#ECF230" cx="108" cy="50" r="13"/><circle cx="38" cy="50" r="5"/><circle cx="73" cy="47" r="5"/><circle cx="108" cy="50" r="5"/></svg>',nomMouth:ART_COMMON+'<ellipse cx="74" cy="108" rx="22" ry="22"/><path fill="#FFFFFF" d="M68.4 129.7l5.8-14.8l9.2 13.8C83.5 128 74 132 68 129.7z"/></svg>',monMouth:ART_COMMON+'<ellipse cx="73" cy="106" rx="21" ry="21"/><path fill="#FFFFFF" d="M63.3 87.6l9.4 13.1l7.2-14.8C79.9 85 72 82 63 87.6z"/></svg>',eat:ART_COMMON+'<path d="M97.2 103.4c0 12.5-9.7 1.9-22.1 1.9s-22.9 10.6-22.9-1.9s10.1-1.9 22.5-1.9S97.2 90.9 97.2 103.4z"/></svg>',title_art:'<svg xmlns="http://www.w3.org/2000/svg" version="1" x="0" y="0" viewBox="0 0 720 640" enable-background="new 0 0 720 640" xml:space="preserve"><text style="text-shadow: 10px 10px 0 rgba(1,255,223, 0.6), 20px 20px 0 rgba(255,0,0, 0.6), 30px 30px 0 rgba(1,255,223, 0.6), 40px 40px 0 rgba(255,0,0, 0.6),; font-weight: bold;" transform="matrix(1 0 0 1 98.3608 217.1597)"><tspan x="0" y="0" fill="#ECF230" font-family="\'Verdana\'" font-size="99">NOM</tspan><tspan x="262" y="0" fill="#F23869" font-family="\'Verdana\'" font-size="99">MON</tspan><tspan x="-40" y="119" fill="#F23869" font-family="\'Verdana\'" font-size="99">BROT</tspan><tspan x="265" y="119" fill="#ECF230" font-family="\'Verdana\'" font-size="99">HERS</tspan></text></svg>'},NIBLIT_COLOR_PALET=["","#0033CC","#431359","#FFBA41","#FF0000","#FFFF01"],window.onload=function(){utils=new Utils,graphics=new Graphics,input=new Input,sc=new ServerConnect,nm=new NiblitManager,input.init(),ga=new GameAdmin,ga.enter_menu()};var GameAdmin=function(){function n(){l.style.display="none",c.style.display="none",d.style.display="none",e.style.display="none",f.style.display="none",g.style.display="none",h.style.display="none",k.style.display="none"}function o(){n(),b.style.display="block",d.style.display="block",e.style.display="block"}function p(){n(),f.style.display="block"}function q(){game_name=document.getElementById("input_game_name").value,game_name=game_name.replace(/\W/g,""),""!=game_name&&(n(),g.style.display="block",sc.register_game())}function r(){sc.get_hosted_games()}function s(a){n(),h.style.display="block";for(var b="",c=0;c<a.length;c++)b+='<li id="game_id_'+a[c]+'" class="avalible_game">'+a[c]+"</li>";for(i.innerHTML=b,c=0;c<a.length;c++)!function(b){document.getElementById("game_id_"+a[b]).addEventListener("click",function(){sc.join_game(a[b])})}(c);a.length?j.style.display="none":j.style.display="block"}function e(){}function t(){b.style.display="none",is_host?(player=new Player("nom"),opponent=new Player("mon"),host_interval=setInterval(function(){nm.ready_niblit_batch()},5e3)):(player=new Player("mon"),opponent=new Player("nom")),nm.avatars.push(player.avatar),nm.avatars.push(opponent.avatar),is_host&&nm.ready_niblit_batch(),spawn_interval=setInterval(function(){nm.niblit_factory.make_niblit()},100),opponent_update_interval=setInterval(function(){sc.socket.emit("game_update",{opponent_pos:player.avatar.position,niblits_eaten:niblits_eaten}),niblits_eaten=[]},34),reverse_meter_interval=setInterval(add_to_reverse_meter,600),Game.paused=!1,n(),l.style.display="block",c.style.display="block",game_minutes=0,game_seconds=15,game_centa_seconds=0,m=setInterval(function(){game_centa_seconds--,0>game_centa_seconds&&(game_centa_seconds+=100,game_seconds--,0>game_seconds&&(game_seconds+=60,game_minutes--,0>game_minutes&&(clearInterval(m),u())))},10)}function u(){Game.paused=!0,is_host&&clearInterval(host_interval),clearInterval(spawn_interval),clearInterval(reverse_meter_interval),niblits_eaten=[],n(),k.style.display="block"}function v(){reverse_meter=0,rolling_niblit_id=1,nm.niblits=[],nm.pending_niblits=[],nm.avatars=[]}var m,b=document.getElementById("title"),c=document.getElementById("game_canvas"),d=document.getElementById("host_game"),e=document.getElementById("join_game"),f=document.getElementById("enter_game_name_overlay"),g=document.getElementById("waiting_for_opponent"),h=document.getElementById("games_to_join"),i=document.getElementById("list_of_games"),j=document.getElementById("no_games"),k=document.getElementById("rematch"),l=document.getElementById("HUD");d.addEventListener("click",p),document.getElementById("enter_game_name_overlay_confirm").addEventListener("click",q),document.getElementById("enter_game_name_overlay_cancel").addEventListener("click",o),document.getElementById("waiting_overlay_cancel").addEventListener("click",function(a){sc.unregister_game(),o()}),e.addEventListener("click",r),document.getElementById("games_to_join_cancel").addEventListener("click",function(){sc.stop_browsing(),o()}),document.getElementById("rematch_cancel").addEventListener("click",function(){sc.socket.emit("left_game",{}),v(),o()}),document.getElementById("rematch_confirm").addEventListener("click",function(){v(),n(),g.style.display="block",sc.socket.emit("lets_rematch",{})}),this.enter_menu=o,this.show_hosted_games=s,this.start_match=t,this.clean_up_match=v},Player=function(a){this.score=0,this.old_score=0,this.upgrade_points=0,this.avatar=new Avatar(a)};Player.prototype.chomp=function(a){this.score+=a.points,this.upgrade_points+=a.points,this.avatar.chomps<3&&this.avatar.chomps++},Player.prototype.try_upgrade=function(){this.avatar.max_level||this.upgrade_points<this.avatar.level_up[this.avatar.level]||(this.upgrade_points-=this.avatar.level_up[this.avatar.level],this.avatar.do_upgrade(),sc.socket.emit("game_update",{upgrade:!0}))},Player.prototype.try_reverse=function(){reverse_meter<REVERSE_MAX||(reverse_meter=0,sc.socket.emit("game_update_both",{reverse:!0}))};var Avatar=function(a){this.BITE_TIME_MAX=.2,this.bite_time=0,this.img_body=document.createElement("IMG"),this.img_open=document.createElement("IMG"),this.img_eat=document.createElement("IMG"),"nom"===a?(this.position={x:50,y:50},this.color="red",this.img_body.src=DOMURL.createObjectURL(new Blob([ART.nomHead],{type:"image/svg+xml;charset=utf-8"})),this.img_open.src=DOMURL.createObjectURL(new Blob([ART.nomMouth],{type:"image/svg+xml;charset=utf-8"}))):(this.position={x:150,y:50},this.color="blue",this.img_body.src=DOMURL.createObjectURL(new Blob([ART.monHead],{type:"image/svg+xml;charset=utf-8"})),this.img_open.src=DOMURL.createObjectURL(new Blob([ART.monMouth],{type:"image/svg+xml;charset=utf-8"}))),this.img_eat.src=DOMURL.createObjectURL(new Blob([ART.eat],{type:"image/svg+xml;charset=utf-8"})),this.img_mouth=this.img_open,this.radius=25,this.speed=150,this.level=1,this.rank=1,this.max_level=!1,this.level_up=[0,20,30,40,50,60,70,80,90,100],this.mouth_open=!0,this.chomps=0};Avatar.prototype.move=function(a){var b=utils.normalize(player.avatar.position.x-graphics.camera.x,player.avatar.position.y-graphics.camera.y,input.mouse.x,input.mouse.y);player.avatar.position.x+=b[0]*player.avatar.speed*a,player.avatar.position.y+=b[1]*player.avatar.speed*a;for(var c=0;c<nm.niblits.length;c++)if(nm.niblits[c].points<=player.avatar.rank&&utils.proximity(player.avatar.position,nm.niblits[c])<player.avatar.radius+nm.niblits[c].size){var d=nm.niblits.splice(c,1)[0];c--,niblits_eaten.push(d.n_id),player.chomp(d)}},Avatar.prototype.do_upgrade=function(){this.level++,this.level%2==0?this.speed+=50:(this.rank++,this.radius+=5),10==this.level&&(this.max_level=!0)},Avatar.prototype.animate=function(a){this.chomps&&(this.bite_time-=a,this.bite_time<0&&(this.bite_time+=this.BITE_TIME_MAX,this.mouth_open=!this.mouth_open,this.mouth_open?(this.img_mouth=this.img_open,this.chomps--):this.img_mouth=this.img_eat))};var Niblit=function(a){this.x=a.x,this.y=a.y,this.size=a.size,this.points=a.points,this.n_id=rolling_niblit_id,this.color=NIBLIT_COLOR_PALET[a.points],rolling_niblit_id++},NiblitManager=function(){this.niblits=[],this.niblit_factory=new NiblitFactory(this),this.avatars=[],this.pending_niblits=[]};NiblitManager.prototype.ready_niblit_batch=function(){var a,b,c,d,e;a=this.avatars[0].rank,b=a,this.avatars[1].level>b?b=this.avatars[1].rank:a=this.avatars[1].rank,niblit_batch=[];for(var f=0;20>f&&!(this.niblits.length+f>=MAX_NIBLITS);f++)c=Math.ceil(Math.random()*b),d=parseInt(Math.random()*ARENA_WIDTH),e=parseInt(Math.random()*ARENA_HEIGHT),niblit_batch.push({rank:c,x:d,y:e});sc.socket.emit("game_update_both",{niblit_batch:niblit_batch})};var NiblitFactory=function(a){var b=[0,4,7,10,14,18];this.make_niblit=function(){if(a.pending_niblits.length){var c=a.pending_niblits.shift(),d=new Niblit({x:c.x,y:c.y,size:b[c.rank],points:c.rank});a.niblits.push(d)}}},Utils=function(){};Utils.prototype.normalize=function(a,b,c,d){var e=c-a,f=d-b,g=e*e+f*f;return g=Math.sqrt(g),[e/g,f/g]},Utils.prototype.proximity=function(a,b){var c=b.x-a.x,d=b.y-a.y;return Math.sqrt(c*c+d*d)};var Graphics=function(){this.canvas=document.getElementById("game_canvas"),this.context=this.canvas.getContext("2d"),this.camera={x:0,y:0},this.game_time=document.getElementById("game_time"),this.hud={score:document.getElementById("player_score"),opponent:document.getElementById("opponent_score"),player_lv:document.getElementById("player_lv"),opponent_lv:document.getElementById("opponent_lv"),upgrade_text:document.getElementById("upgrade_text"),upgrade_bar_fill:document.getElementById("upgrade_bar_fill"),reverse_bar_fill:document.getElementById("reverse_bar_fill")};var a=document.getElementById("title_canvas").getContext("2d");a.clearRect(0,0,720,640);var b=document.createElement("IMG");b.src=DOMURL.createObjectURL(new Blob([ART.title_art],{type:"image/svg+xml;charset=utf-8"}));var c=document.createElement("IMG");c.src=DOMURL.createObjectURL(new Blob([ART.nomHead],{type:"image/svg+xml;charset=utf-8"}));var d=document.createElement("IMG");d.src=DOMURL.createObjectURL(new Blob([ART.monHead],{type:"image/svg+xml;charset=utf-8"}));var e=document.createElement("IMG");e.src=DOMURL.createObjectURL(new Blob([ART.nomMouth],{type:"image/svg+xml;charset=utf-8"}));var f=document.createElement("IMG");f.src=DOMURL.createObjectURL(new Blob([ART.monMouth],{type:"image/svg+xml;charset=utf-8"})),setTimeout(function(){a.drawImage(b,0,0,720,640),a.drawImage(c,184,138,85,85),a.drawImage(e,184,138,85,85),a.drawImage(d,456,138,85,85),a.drawImage(f,456,138,85,85)},100)};Graphics.prototype.draw=function(){var a=this.context;this.camera.x=player.avatar.position.x-SCREEN_WIDTH/2,this.camera.y=player.avatar.position.y-SCREEN_HEIGHT/2,this.camera.x<0&&(this.camera.x=0),this.camera.x>ARENA_WIDTH-SCREEN_WIDTH&&(this.camera.x=ARENA_WIDTH-SCREEN_WIDTH),this.camera.y<0&&(this.camera.y=0),this.camera.y>ARENA_HEIGHT-SCREEN_HEIGHT&&(this.camera.y=ARENA_HEIGHT-SCREEN_HEIGHT),a.clearRect(0,0,this.canvas.width,this.canvas.height),a.save(),a.fillStyle="rgba(255, 255, 255, 0.0)",a.strokeStyle="rgba(0, 0, 0, 0.25)";for(var b=0;64>b;b++)a.beginPath(),a.arc(b%8*150+75-this.camera.x,150*parseInt(b/8)+75-this.camera.y,10,0,2*Math.PI,!1),a.stroke();for(a.lineWidth=15,a.strokeStyle="#F23869",a.beginPath(),a.rect(0-this.camera.x,0-this.camera.y,ARENA_WIDTH,ARENA_HEIGHT),a.stroke(),b=0;b<nm.niblits.length;b++)a.lineWidth=1,a.strokeStyle="#BBBBBB",a.fillStyle=nm.niblits[b].color,a.beginPath(),a.arc(nm.niblits[b].x-this.camera.x,nm.niblits[b].y-this.camera.y,nm.niblits[b].size,0,2*Math.PI,!1),a.fill(),a.stroke();a.drawImage(opponent.avatar.img_body,opponent.avatar.position.x-this.camera.x-opponent.avatar.radius,opponent.avatar.position.y-this.camera.y-opponent.avatar.radius,2*opponent.avatar.radius,2*opponent.avatar.radius),a.drawImage(opponent.avatar.img_mouth,opponent.avatar.position.x-this.camera.x-opponent.avatar.radius,opponent.avatar.position.y-this.camera.y-opponent.avatar.radius,2*opponent.avatar.radius,2*opponent.avatar.radius),a.drawImage(player.avatar.img_body,player.avatar.position.x-this.camera.x-player.avatar.radius,player.avatar.position.y-this.camera.y-player.avatar.radius,2*player.avatar.radius,2*player.avatar.radius),a.drawImage(player.avatar.img_mouth,player.avatar.position.x-this.camera.x-player.avatar.radius,player.avatar.position.y-this.camera.y-player.avatar.radius,2*player.avatar.radius,2*player.avatar.radius),this.game_time.innerHTML="Time: "+game_minutes+":"+(10>game_seconds?"0"+game_seconds:game_seconds)+":"+(10>game_centa_seconds?"0"+game_centa_seconds:game_centa_seconds),this.hud.score.innerHTML=""+player.score,this.hud.opponent.innerHTML=""+opponent.score,this.hud.player_lv.innerHTML="lv "+player.avatar.level,this.hud.opponent_lv.innerHTML="lv "+opponent.avatar.level,player.avatar.max_level?this.hud.upgrade_text.innerHTML="MAX":this.hud.upgrade_text.innerHTML=""+player.upgrade_points+"/"+player.avatar.level_up[player.avatar.level],a.fillText("Reverse: "+reverse_meter+"/"+REVERSE_MAX,50,75),a.restore()};var Input=function(){this.mouse={x:0,y:0}};Input.prototype.init=function(){var a=document.getElementById("game_canvas"),b=this.mouse;a.addEventListener("mousemove",function(c){b.x=c.x-a.offsetLeft,b.y=c.y-a.offsetTop}),a.addEventListener("mouseleave",function(a){player.stop_moving=!0}),a.addEventListener("mouseenter",function(a){player.stop_moving=!1}),window.addEventListener("keydown",function(a){"U+0055"==a.keyIdentifier?player.try_upgrade():"U+0052"==a.keyIdentifier&&player.try_reverse()})};var ServerConnect=function(){this.socket=io.connect(document.location.href);this.lets_play=function(){this.socket.emit("lets_play",{})},this.register_game=function(){this.socket.emit("register_game",{name:game_name})},this.unregister_game=function(){this.socket.emit("unregister_game",{name:game_name})},this.get_hosted_games=function(){this.socket.emit("get_registered_games",{})},this.socket.on("registered_games",function(a){ga.show_hosted_games(a)}),this.stop_browsing=function(){this.socket.emit("stop_browsing",{})},this.join_game=function(a){this.socket.emit("join_game",{name:a})},this.socket.on("left_game",function(a){ga.clean_up_match(),ga.enter_menu()}),this.socket.on("game_start",function(a){is_host=a.game_host,ga.start_match()}),this.socket.on("do_rematch",function(a){ga.start_match()}),this.socket.on("game_update",function(a){if(a.opponent_pos){opponent.avatar.position=a.opponent_pos;for(var b=0;b<a.niblits_eaten.length;b++)for(var c=0;c<nm.niblits.length;c++)a.niblits_eaten[b]==nm.niblits[c].n_id&&(opponent.chomp(nm.niblits.splice(c,1)[0]),c--)}else a.niblit_batch?nm.pending_niblits=nm.pending_niblits.concat(a.niblit_batch):a.reverse?reverse_avatars():a.upgrade&&opponent.avatar.do_upgrade()})};Game.paused=!0,Game.update=function(a){Game.paused||(player.stop_moving||player.avatar.move(a),player.avatar.animate(a),opponent.avatar.animate(a))},Game.run=function(){var a=1e3/Game.config.fps;return start_tick=next_tick=last_tick=(new Date).getTime(),num_frames=0,function(){for(current_tick=(new Date).getTime();current_tick>next_tick;)delta=(current_tick-last_tick)/1e3,Game.update(delta),next_tick+=a,last_tick=(new Date).getTime();graphics&&player&&graphics.draw(),fps=num_frames/(current_tick-start_tick)*1e3,num_frames++}}(),window.requestAnimationFrame?window.each_frame=function(a){var b=function(){a(),requestAnimationFrame(b)};b()}:window.mozRequestAnimationFrame?window.each_frame=function(a){var b=function(){a(),mozRequestAnimationFrame(b)};b()}:window.each_frame=function(a){setInterval(a,1e3/Game.config.fps)},window.each_frame(Game.run);